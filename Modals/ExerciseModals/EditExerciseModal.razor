@using System.ComponentModel.DataAnnotations
@using FitnessPT.Services
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@inject IExerciseApiService ExerciseApiService
@inject IJSRuntime JSRuntime

<div class="modal fade" id="editExerciseModal" tabindex="-1" aria-labelledby="editExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editExerciseModalLabel">
                    <i class="fas fa-edit text-warning"></i> 운동 수정
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <EditForm Model="@model" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="row">
                        <!-- 운동명 -->
                        <div class="col-12 mb-3">
                            <label for="editExerciseName" class="form-label">
                                <i class="fas fa-dumbbell"></i> 운동명 <span class="text-danger">*</span>
                            </label>
                            <InputText id="editExerciseName" class="form-control" @bind-Value="model.ExerciseName" 
                                       placeholder="예: 푸시업, 벤치프레스" />
                            <ValidationMessage For="@(() => model.ExerciseName)" class="text-danger" />
                        </div>

                        <!-- 카테고리와 난이도 -->
                        <div class="col-md-6 mb-3">
                            <label for="editCategoryId" class="form-label">
                                <i class="fas fa-folder"></i> 카테고리
                            </label>
                            <InputSelect id="editCategoryId" class="form-select" @bind-Value="model.PrimaryCategoryId">
                                <option value="">카테고리를 선택하세요</option>
                                @if (Categories != null)
                                {
                                    @foreach (var category in Categories.Where(c => c.ParentCategoryId == null))
                                    {
                                        <optgroup label="@category.CategoryName">
                                            <option value="@category.CategoryId">@category.CategoryName</option>
                                            @if (category.SubCategories != null)
                                            {
                                                @foreach (var subCategory in category.SubCategories)
                                                {
                                                    <option value="@subCategory.CategoryId">├─ @subCategory.CategoryName</option>
                                                }
                                            }
                                        </optgroup>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => model.PrimaryCategoryId)" class="text-danger" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="editDifficultyLevel" class="form-label">
                                <i class="fas fa-chart-line"></i> 난이도
                            </label>
                            <InputSelect id="editDifficultyLevel" class="form-select" @bind-Value="model.DifficultyLevel">
                                <option value="">난이도를 선택하세요</option>
                                <option value="1">1 - 초급 (Beginner)</option>
                                <option value="2">2 - 중급 (Intermediate)</option>
                                <option value="3">3 - 고급 (Advanced)</option>
                                <option value="4">4 - 전문가 (Expert)</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => model.DifficultyLevel)" class="text-danger" />
                        </div>

                        <!-- 대상 근육 -->
                        <div class="col-12 mb-3">
                            <label for="editTargetMuscles" class="form-label">
                                <i class="fas fa-crosshairs"></i> 대상 근육
                            </label>
                            <InputText id="editTargetMuscles" class="form-control" @bind-Value="model.TargetMuscles" 
                                       placeholder="예: 가슴, 삼두근, 어깨" />
                            <ValidationMessage For="@(() => model.TargetMuscles)" class="text-danger" />
                        </div>

                        <!-- 활성 상태 -->
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <InputCheckbox id="editIsActive" class="form-check-input" @bind-Value="model.IsActive" />
                                <label for="editIsActive" class="form-check-label">
                                    <i class="fas fa-toggle-on"></i> 활성 상태
                                </label>
                            </div>
                            <div class="form-text">
                                비활성화하면 사용자에게 표시되지 않습니다.
                            </div>
                        </div>

                        <!-- 운동 설명 -->
                        <div class="col-12 mb-3">
                            <label for="editInstructions" class="form-label">
                                <i class="fas fa-list-ol"></i> 운동 설명
                            </label>
                            <InputTextArea id="editInstructions" class="form-control" rows="5" @bind-Value="model.Instructions" 
                                           placeholder="운동 수행 방법을 자세히 설명해주세요." />
                            <ValidationMessage For="@(() => model.Instructions)" class="text-danger" />
                        </div>
                    </div>

                    @if (isSubmitting)
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">저장 중...</span>
                            </div>
                            <div class="mt-2">운동을 수정하는 중입니다...</div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> @errorMessage
                        </div>
                    }

                    <!-- 수정 시 주의사항 -->
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>주의:</strong> 이 운동을 사용하는 운동 기록이 있을 수 있습니다. 
                        중요한 정보를 변경할 때는 신중하게 검토해주세요.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" disabled="@isSubmitting">
                        취소
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>저장 중...</span>
                        }
                        else
                        {
                            <i class="fas fa-save"></i>
                            <span>수정 저장</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public List<CategoryDto>? Categories { get; set; }
    [Parameter] public EventCallback OnExerciseUpdated { get; set; }

    private EditExerciseModel model = new();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private int exerciseId = 0;

    public async Task ShowAsync(ExerciseDto exercise)
    {
        // 모델 초기화
        exerciseId = exercise.ExerciseId;
        model = new EditExerciseModel
        {
            ExerciseName = exercise.ExerciseName,
            PrimaryCategoryId = exercise.PrimaryCategoryId,
            DifficultyLevel = exercise.DifficultyLevel,
            TargetMuscles = exercise.TargetMuscles,
            Instructions = exercise.Instructions,
            IsActive = exercise.IsActive ?? true
        };

        errorMessage = string.Empty;
        isSubmitting = false;

        // 모달 표시
        await JSRuntime.InvokeVoidAsync("showModal", "editExerciseModal");
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            var updateDto = new UpdateExerciseDto
            {
                ExerciseName = model.ExerciseName,
                PrimaryCategoryId = model.PrimaryCategoryId,
                DifficultyLevel = model.DifficultyLevel,
                TargetMuscles = model.TargetMuscles,
                Instructions = model.Instructions,
                IsActive = model.IsActive
            };

            var result = await ExerciseApiService.UpdateExerciseAsync(exerciseId, updateDto);

            if (result != null)
            {
                // 성공 시 모달 닫기
                await JSRuntime.InvokeVoidAsync("hideModal", "editExerciseModal");
                await OnExerciseUpdated.InvokeAsync();
            }
            else
            {
                errorMessage = "운동 수정에 실패했습니다. 다시 시도해주세요.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"오류가 발생했습니다: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    public class EditExerciseModel
    {
        [Required(ErrorMessage = "운동명은 필수입니다.")]
        [StringLength(100, ErrorMessage = "운동명은 100자를 초과할 수 없습니다.")]
        public string ExerciseName { get; set; } = string.Empty;

        public int? PrimaryCategoryId { get; set; }

        [Range(1, 4, ErrorMessage = "난이도는 1-4 사이의 값이어야 합니다.")]
        public int? DifficultyLevel { get; set; }

        [StringLength(200, ErrorMessage = "대상 근육은 200자를 초과할 수 없습니다.")]
        public string? TargetMuscles { get; set; }

        public string? Instructions { get; set; }

        public bool IsActive { get; set; } = true;
    }
}