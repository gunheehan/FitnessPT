@page "/login"
@using FitnessPT.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IConfiguration Configuration
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>ë¡œê·¸ì¸ - FitnessPT</PageTitle>

<div class="login-page">
    <div class="login-card">
        <div class="login-header">
            <h1>ğŸ‹ï¸ FitnessPT</h1>
            <p class="subtitle">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”</p>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                @errorMessage
            </div>
        }
        else if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                @successMessage
            </div>
        }

        <div class="google-signin-wrapper">
            <div id="googleButtonContainer"></div>
        </div>

        <div class="info-section">
            <p>ğŸ”’ ì•ˆì „í•œ Google OAuth ì¸ì¦</p>
            <p>ğŸ“± ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ê¸°í™”</p>
            <p>ğŸ¯ ê°„í¸í•œ ìš´ë™ ê¸°ë¡ ê´€ë¦¬</p>
        </div>
    </div>
</div>

@code {
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;
    private DotNetObjectReference<Login>? dotNetRef;
    private IJSObjectReference? module;

    private string GoogleClientId => Configuration["Authentication:Google:ClientId"] ?? "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                module = await JS.InvokeAsync<IJSObjectReference>(
                    "import", "./Components/Pages/Login.razor.js");

                dotNetRef = DotNetObjectReference.Create(this);

                await JS.InvokeVoidAsync("Login.initialize", 
                    dotNetRef, GoogleClientId); 
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Script load error: {ex.Message}");
                errorMessage = "í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public async Task HandleGoogleLogin(string googleToken)
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            Console.WriteLine($"ğŸ” Google Token received");

            var result = await AuthService.LoginWithGoogleAsync(googleToken);

            if (result.Success)
            {
                successMessage = $"í™˜ì˜í•©ë‹ˆë‹¤, {result.User?.Name}ë‹˜!";
                StateHasChanged();

                await Task.Delay(3000);
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
            Console.Error.WriteLine($"Login error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        dotNetRef?.Dispose();

        if (module != null)
        {
            await module.DisposeAsync();
        }
    }
}