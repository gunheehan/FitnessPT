@using FitnessPT.Components.Controllers
@using FitnessPT.Components.Shared
@using FitnessPT.Models
@inject RoutineController Controller

@rendermode InteractiveServer

<div class="modal-overlay @(IsActive ? "active" : "disabled")" @onclick="OnClose">
    <div class="modal-content @(state == ModalState.PREVIEW ? "view-mode" : "")" @onclick:stopPropagation>
        <div class="modal-header">
            <h2>
                @if (state == ModalState.PREVIEW)
                {
                    <span>üëÅÔ∏è Î£®Ìã¥ ÎØ∏Î¶¨Î≥¥Í∏∞</span>
                }
                else if (state == ModalState.EDIT)
                {
                    <span>‚úèÔ∏è Î£®Ìã¥ ÏàòÏ†ï</span>
                }
                else
                {
                    <span>‚ûï ÏÉà Î£®Ìã¥ Ï∂îÍ∞Ä</span>
                }
            </h2>
            <div class="header-actions">
                @if (state == ModalState.PREVIEW)
                {
                    <button class="btn btn-edit" @onclick="SwitchToEditMode">
                        ‚úèÔ∏è ÏàòÏ†ïÌïòÍ∏∞
                    </button>
                }
                <button class="btn-close" @onclick="OnClose">‚úñ</button>
            </div>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>Î£®Ìã¥ Ïù¥Î¶Ñ <span class="required">*</span></label>
                <input type="text"
                       class="form-control"
                       @bind="Routine.Name"
                       placeholder="Ïòà: ÏÉÅÏ≤¥ Î∞ïÏÇ¥ Î£®Ìã¥"
                       disabled="@(state == ModalState.PREVIEW)"/>
            </div>

            <div class="form-group">
                <label>ÏÑ§Î™Ö</label>
                <textarea class="form-control"
                          @bind="Routine.Description"
                          rows="3"
                          placeholder="Ïö¥ÎèôÏóê ÎåÄÌïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                          disabled="@(state == ModalState.PREVIEW)"></textarea>
            </div>

            <div class="form-group">
                <label>Î£®Ìã¥ Î∂ÑÎ•ò</label>
                @if (state == ModalState.PREVIEW)
                {
                    <div class="view-badges">
                        <span class="badge-view level">@GetLevelText()</span>
                        <span class="badge-view category">@GetCategoryText()</span>
                    </div>
                }
                else
                {
                    <CategoryFillter
                        isEdit="true"
                        @bind-SelectedLevel="Routine.Level"
                        @bind-SelectedCategory="Routine.Category"
                        OnFiltersChanged="ApplyFilters" />
                }
            </div>

            <div class="form-group">
                <label>Ïù¥ÎØ∏ÏßÄ URL</label>
                <input type="url"
                       class="form-control"
                       @bind="Routine.ThumbnailUrl"
                       placeholder="https://example.com/image.jpg"
                       disabled="@(state == ModalState.PREVIEW)" />
                @if (!string.IsNullOrEmpty(Routine.ThumbnailUrl))
                {
                    <div class="image-preview">
                        <img src="@Routine.ThumbnailUrl" alt="ÎØ∏Î¶¨Î≥¥Í∏∞" />
                    </div>
                }
            </div>

            @if (state != ModalState.PREVIEW)
            {
                <div class="form-group">
                    <label>Ïö¥Îèô Ï¢ÖÎ™© Ï∂îÍ∞Ä</label>
                    <ExerciseSelecter OnSelectExercise="AddExercise"/>
                </div>
            }

            @* ÏÑ†ÌÉùÎêú Ïö¥Îèô Î™©Î°ù *@
            @if (exerciseList.Any())
            {
                <div class="form-group">
                    <label>ÏÑ†ÌÉùÎêú Ïö¥Îèô Î™©Î°ù (@exerciseList.Count Í∞ú)</label>
                    <div class="exercise-list">
                        @foreach (var (exercise, index) in exerciseList.Select((e, i) => (e, i)))
                        {
                            <div class="exercise-item">
                                <div class="exercise-header">
                                    <span class="order-badge">@exercise.OrderIndex</span>
                                    <h4>@exercise.ExerciseName</h4>
                                    @if (state != ModalState.PREVIEW)
                                    {
                                        <button class="btn-remove" @onclick="() => RemoveExercise(index)">
                                            üóëÔ∏è
                                        </button>
                                    }
                                </div>

                                <div class="exercise-inputs">
                                    <div class="input-group">
                                        <label>ÏÑ∏Ìä∏</label>
                                        <input type="number"
                                               min="1"
                                               @bind="exercise.Sets"
                                               class="form-control-sm"
                                               disabled="@(state == ModalState.PREVIEW)" />
                                    </div>

                                    <div class="input-group">
                                        <label>Î∞òÎ≥µ</label>
                                        <input type="number"
                                               min="1"
                                               @bind="exercise.Reps"
                                               class="form-control-sm"
                                               disabled="@(state == ModalState.PREVIEW)" />
                                    </div>

                                    <div class="input-group">
                                        <label>Ïö¥Îèô ÏãúÍ∞Ñ(Ï¥à)</label>
                                        <input type="number"
                                               min="0"
                                               @bind="exercise.DurationSeconds"
                                               class="form-control-sm"
                                               placeholder="ÏÑ†ÌÉù"
                                               disabled="@(state == ModalState.PREVIEW)" />
                                    </div>

                                    <div class="input-group">
                                        <label>Ìú¥Ïãù(Ï¥à)</label>
                                        <input type="number"
                                               min="0"
                                               @bind="exercise.RestSeconds"
                                               class="form-control-sm"
                                               disabled="@(state == ModalState.PREVIEW)" />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="modal-footer">
            @if (state == ModalState.PREVIEW)
            {
                <button class="btn btn-secondary" @onclick="OnClose">
                    Îã´Í∏∞
                </button>
            }
            else
            {
                <button class="btn btn-secondary" @onclick="OnClose">
                    Ï∑®ÏÜå
                </button>
                <button class="btn btn-primary"
                        @onclick="HandleSave"
                        disabled="@(!IsValid())">
                    @((state == ModalState.EDIT) ? "ÏàòÏ†ï" : "Ï∂îÍ∞Ä")
                </button>
            }
        </div>
    </div>
</div>

<link href="~/css/modal-common.css" rel="stylesheet" />
<link href="~/css/rouine-modal.css" rel="stylesheet" />